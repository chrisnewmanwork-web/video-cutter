<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Cutter - MP4 Output</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .upload-box input {
            display: none;
        }

        .upload-label {
            font-size: 1.2em;
            color: #667eea;
            font-weight: 600;
        }

        .video-preview {
            margin: 30px 0;
            display: none;
        }

        video {
            width: 100%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: block;
            margin: 0 auto;
        }

        .video-info {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .time-controls {
            margin: 30px 0;
            display: none;
        }

        .time-range {
            background: #f8f9ff;
            border: 2px solid #e0e4ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        input[type="number"] {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove {
            background: #ff4757;
            color: white;
        }

        .btn-remove:hover {
            background: #e84118;
            transform: translateY(-2px);
        }

        .btn-add {
            background: #667eea;
            color: white;
            width: 100%;
            margin-bottom: 20px;
        }

        .btn-add:hover {
            background: #764ba2;
        }

        .btn-process {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 1.1em;
        }

        .btn-process:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-process:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
            text-align: center;
        }

        .success-box {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .progress {
            display: none;
            margin: 20px 0;
            text-align: center;
        }

        .progress-text {
            color: #555;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .output-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .download-btn {
            background: #10ac84;
            color: white;
            display: block;
            width: 100%;
            margin-top: 15px;
        }

        .download-btn:hover {
            background: #0e9d73;
        }

        .helper-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .helper-btn {
            background: #f0f0f0;
            color: #555;
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .helper-btn:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Video Cutter</h1>
        
        <div class="upload-section">
            <div class="upload-box" onclick="document.getElementById('videoInput').click()">
                <input type="file" id="videoInput" accept="video/*">
                <div class="upload-label">üìÅ Click to upload a video</div>
            </div>
        </div>

        <div class="video-preview" id="videoPreview">
            <video id="videoPlayer" controls></video>
            <div class="video-info" id="videoInfo"></div>
            <div class="helper-buttons">
                <button class="btn helper-btn" onclick="setCurrentTimeAsStart()">Use Current Time as Start</button>
                <button class="btn helper-btn" onclick="setCurrentTimeAsEnd()">Use Current Time as End</button>
            </div>
        </div>

        <div class="time-controls" id="timeControls">
            <h2 style="margin-bottom: 20px; color: #333;">Time Ranges to Keep</h2>
            <div id="timeRanges"></div>
            <button class="btn btn-add" onclick="addTimeRange()">+ Add Time Range</button>
            
            <div class="success-box">
                ‚úÖ Self-hosted FFmpeg - no external CDN dependencies. Outputs MP4 format.
                <br>First use downloads ~30MB of FFmpeg files (one-time, cached by browser).
            </div>
            
            <button class="btn btn-process" id="processBtn" onclick="processVideo()">Cut Video</button>
            <p class="info-text">Enter times in seconds. Example: Start: 5, End: 15 keeps seconds 5-15.</p>
        </div>

        <div class="progress" id="progress">
            <p class="progress-text" id="progressText">Processing video...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div class="output-section" id="outputSection">
            <h2 style="margin-bottom: 15px; color: #333;">‚úÖ Video Ready!</h2>
            <video id="outputVideo" controls style="margin-bottom: 15px;"></video>
            <button class="btn download-btn" onclick="downloadVideo()">‚¨áÔ∏è Download Cut Video (MP4)</button>
        </div>
    </div>

    <!-- Load FFmpeg libraries from local files -->
    <script src="./libs/ffmpeg.js"></script>
    <script src="./libs/util.js"></script>
    <script>
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile, toBlobURL } = FFmpegUtil;

        let videoFile = null;
        let outputBlob = null;
        let videoDuration = 0;
        let ffmpeg = null;
        let ffmpegLoaded = false;

        document.getElementById('videoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                videoFile = file;
                const videoURL = URL.createObjectURL(file);
                
                const videoPlayer = document.getElementById('videoPlayer');
                videoPlayer.src = videoURL;
                
                videoPlayer.addEventListener('loadedmetadata', function() {
                    videoDuration = videoPlayer.duration;
                    document.getElementById('videoInfo').textContent = 
                        `Duration: ${formatTime(videoDuration)} | File: ${file.name}`;
                });
                
                document.getElementById('videoPreview').style.display = 'block';
                document.getElementById('timeControls').style.display = 'block';
                
                if (document.getElementById('timeRanges').children.length === 0) {
                    addTimeRange();
                }
            }
        });

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function setCurrentTimeAsStart() {
            const video = document.getElementById('videoPlayer');
            const ranges = document.querySelectorAll('.time-range');
            if (ranges.length > 0) {
                const lastRange = ranges[ranges.length - 1];
                const startInput = lastRange.querySelector('.start-time');
                startInput.value = video.currentTime.toFixed(2);
            }
        }

        function setCurrentTimeAsEnd() {
            const video = document.getElementById('videoPlayer');
            const ranges = document.querySelectorAll('.time-range');
            if (ranges.length > 0) {
                const lastRange = ranges[ranges.length - 1];
                const endInput = lastRange.querySelector('.end-time');
                endInput.value = video.currentTime.toFixed(2);
            }
        }

        function addTimeRange() {
            const container = document.getElementById('timeRanges');
            
            const rangeDiv = document.createElement('div');
            rangeDiv.className = 'time-range';
            rangeDiv.innerHTML = `
                <div class="time-inputs">
                    <div class="input-group">
                        <label>Start Time (seconds)</label>
                        <input type="number" class="start-time" min="0" step="0.01" placeholder="0" value="0">
                    </div>
                    <div class="input-group">
                        <label>End Time (seconds)</label>
                        <input type="number" class="end-time" min="0" step="0.01" placeholder="${videoDuration}" value="${videoDuration}">
                    </div>
                    <button class="btn btn-remove" onclick="removeTimeRange(this)">Remove</button>
                </div>
            `;
            
            container.appendChild(rangeDiv);
        }

        function removeTimeRange(btn) {
            btn.closest('.time-range').remove();
        }

        function getTimeRanges() {
            const ranges = [];
            const rangeElements = document.querySelectorAll('.time-range');
            
            rangeElements.forEach(element => {
                const start = parseFloat(element.querySelector('.start-time').value) || 0;
                const end = parseFloat(element.querySelector('.end-time').value) || 0;
                
                if (end > start) {
                    ranges.push({ start, end });
                }
            });
            
            ranges.sort((a, b) => a.start - b.start);
            return ranges;
        }

        async function loadFFmpeg() {
            if (ffmpegLoaded) return;

            ffmpeg = new FFmpeg();
            
            ffmpeg.on('log', ({ message }) => {
                console.log(message);
            });

            ffmpeg.on('progress', ({ progress }) => {
                const percent = Math.round(progress * 100);
                if (percent > 0 && percent < 100) {
                    document.getElementById('progressFill').style.width = percent + '%';
                    document.getElementById('progressFill').textContent = percent + '%';
                }
            });

            // Load core files from local libs folder
            const baseURL = './libs/core';
            
            await ffmpeg.load({
                coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
            });

            ffmpegLoaded = true;
        }

        async function processVideo() {
            if (!videoFile) {
                alert('Please upload a video first!');
                return;
            }

            const ranges = getTimeRanges();
            if (ranges.length === 0) {
                alert('Please add at least one valid time range!');
                return;
            }

            try {
                document.getElementById('processBtn').disabled = true;
                document.getElementById('progress').style.display = 'block';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressFill').textContent = 'Loading FFmpeg...';
                document.getElementById('progressText').textContent = 'Loading FFmpeg...';

                if (!ffmpegLoaded) {
                    await loadFFmpeg();
                }

                document.getElementById('progressText').textContent = 'Processing video...';
                document.getElementById('progressFill').style.width = '10%';
                document.getElementById('progressFill').textContent = '10%';

                const inputFileName = 'input.mp4';
                await ffmpeg.writeFile(inputFileName, await fetchFile(videoFile));

                const segmentFiles = [];
                for (let i = 0; i < ranges.length; i++) {
                    const range = ranges[i];
                    const duration = range.end - range.start;
                    const outputName = `segment${i}.mp4`;
                    
                    document.getElementById('progressText').textContent = 
                        `Cutting segment ${i + 1} of ${ranges.length}...`;
                    
                    await ffmpeg.exec([
                        '-i', inputFileName,
                        '-ss', range.start.toString(),
                        '-t', duration.toString(),
                        '-c', 'copy',
                        '-avoid_negative_ts', '1',
                        outputName
                    ]);
                    
                    segmentFiles.push(outputName);
                    
                    const progress = 10 + ((i + 1) / ranges.length) * 60;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressFill').textContent = Math.round(progress) + '%';
                }

                let finalOutput = 'output.mp4';

                if (segmentFiles.length === 1) {
                    finalOutput = segmentFiles[0];
                } else {
                    document.getElementById('progressText').textContent = 'Merging segments...';
                    
                    const concatList = segmentFiles.map(f => `file '${f}'`).join('\n');
                    await ffmpeg.writeFile('concat.txt', new TextEncoder().encode(concatList));

                    await ffmpeg.exec([
                        '-f', 'concat',
                        '-safe', '0',
                        '-i', 'concat.txt',
                        '-c', 'copy',
                        finalOutput
                    ]);
                }

                document.getElementById('progressFill').style.width = '90%';
                document.getElementById('progressFill').textContent = '90%';
                document.getElementById('progressText').textContent = 'Preparing download...';

                const data = await ffmpeg.readFile(finalOutput);
                outputBlob = new Blob([data.buffer], { type: 'video/mp4' });

                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressFill').textContent = '100%';
                document.getElementById('progressText').textContent = 'Complete!';

                const outputURL = URL.createObjectURL(outputBlob);
                document.getElementById('outputVideo').src = outputURL;
                document.getElementById('outputSection').style.display = 'block';

                setTimeout(() => {
                    document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
                }, 100);

            } catch (error) {
                console.error('Error processing video:', error);
                alert('Error processing video: ' + error.message + '\n\nCheck the browser console for details.');
            } finally {
                document.getElementById('processBtn').disabled = false;
                setTimeout(() => {
                    if (outputBlob) {
                        document.getElementById('progress').style.display = 'none';
                    }
                }, 2000);
            }
        }

        function downloadVideo() {
            if (!outputBlob) return;
            
            const url = URL.createObjectURL(outputBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cut_video.mp4';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
